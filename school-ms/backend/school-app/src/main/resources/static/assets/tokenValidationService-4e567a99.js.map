{"version":3,"mappings":"6JAoBO,MAAMA,EAAqB,SAA8C,CAAO,IAE7E,MAAAC,EAAQ,aAAa,QAAQ,OAAO,EAC1C,GAAI,CAACA,EACH,eAAQ,MAAM,iCAAiC,EAExC,CACL,MAAO,GACP,QAAS,2DACT,aAAc,IAKd,IACI,MAAAC,EAAUC,EAASF,CAAK,EAE9B,GAAI,CAACC,EACH,eAAQ,MAAM,sBAAsB,EAC7B,CAAE,MAAO,GAAO,QAAS,uBAAwB,aAAc,IAGlE,MAAAE,EAAaF,EAAQ,IAAM,IAC3BG,EAAc,KAAK,MACnBC,EAAYD,EAAcD,EAG1BG,GAAgBH,EAAaC,IAAgB,IAAO,IAE1D,GAAIC,EAAW,CAIP,MAAAE,GADeH,EAAcD,IACE,IAAO,GAAK,IAEjD,GAAII,EAAe,GAAI,CACrB,QAAQ,KAAK,iBAAiBA,EAAa,QAAQ,CAAC,CAAC,iDAAiD,EAClG,IAEF,KAAM,CAAE,aAAAC,CAAA,EAAiB,MAAMC,EAAA,WAAO,qBAAuB,6KAC7D,aAAMD,EAAa,EAEnB,QAAQ,IAAI,wDAAwD,EAC7D,CACL,MAAO,GACP,QAAS,gCACT,UAAW,IAAI,KAAK,KAAK,MAAS,GAAK,GAAK,GAAK,EAAE,YAAY,EAC/D,SAAUP,EAAQ,KAAOA,EAAQ,SACjC,cAAe,UAEVS,EAAY,CACX,oBAAK,6DAA8DA,CAAU,EAE9E,CACL,MAAO,GACP,QAAS,6CACT,UAAW,IAAI,KAAKP,CAAU,EAAE,YAAY,EAC5C,SAAUF,EAAQ,KAAOA,EAAQ,SACjC,aAAc,GAElB,MAEA,gBAAQ,MAAM,wCAAwC,EAC/C,CACL,MAAO,GACP,QAAS,8CACT,UAAW,IAAI,KAAKE,CAAU,EAAE,YAAY,EAC5C,SAAUF,EAAQ,KAAOA,EAAQ,SAGvC,CAGA,GAAIK,EAAe,GAAI,CACrB,QAAQ,KAAK,2BAA2BA,EAAa,QAAQ,CAAC,CAAC,uCAAuC,EAElG,IACF,KAAM,CAAE,aAAAE,CAAA,EAAiB,MAAMC,EAAA,WAAO,qBAAuB,6KAC7DD,IAAe,MAAMG,GAAO,QAAQ,KAAK,kCAAmCA,CAAG,CAAC,EAChF,QAAQ,IAAI,iDAAiD,QACtDC,EAAG,CACF,aAAK,2CAA4CA,CAAC,CAC5D,CACF,CAGA,MAAMC,EAAQ,MAAM,QAAQZ,EAAQ,KAAK,EACvCA,EAAQ,MACPA,EAAQ,cAAgBA,EAAQ,KAAO,CAACA,EAAQ,IAAI,EAAI,IAGrDa,EAAUD,EAAM,KAAME,GAAcA,EAAE,gBAAkB,OAAO,EAErE,eAAQ,IAAI,2BAA4B,CACtC,MAAO,GACP,QAAAD,EACA,SAAUb,EAAQ,KAAOA,EAAQ,SACjC,UAAW,IAAI,KAAKE,CAAU,EAAE,eAAe,EAC/C,SAAU,GAAG,KAAK,OAAOA,EAAaC,GAAe,IAAO,EAAE,CAAC,WAChE,EAGM,CACL,MAAO,GACP,SAAUH,EAAQ,KAAOA,EAAQ,SACjC,MAAAY,EACA,UAAW,IAAI,KAAKV,CAAU,EAAE,YAAY,SAEvC,EAAG,CACF,cAAM,2BAA4B,CAAC,CAC7C,CAMO,OACL,MAAO,GACP,GALe,MAAMa,EAAI,IAAI,sBAAsB,GAK9B,CAAC,SAEjBC,EAAY,CACX,qBAAM,0BAA2BA,CAAK,EAGvC,CACL,MAAO,GACP,QAASA,EAAM,SAAW,0BAE9B,CACF,EAEeC,EAAA,CAAE,mBAAAnB,CAAmB","names":["validateAdminToken","token","payload","parseJwt","expiryTime","currentTime","isExpired","timeToExpiry","expiredHours","refreshToken","__vitePreload","refreshErr","err","e","roles","isAdmin","r","api","error","tokenValidationService"],"sources":["../../src/services/tokenValidationService.ts"],"sourcesContent":["// Token validation utility for admin dashboard\r\nimport api from './api';\r\nimport { parseJwt } from './authService';\r\n\r\n// Type for token validation response\r\ninterface TokenValidationResponse {\r\n  valid: boolean;\r\n  username?: string;\r\n  roles?: string[];\r\n  expiresAt?: string;\r\n  message?: string;\r\n  needsRefresh?: boolean;\r\n  autoRefreshed?: boolean;\r\n}\r\n\r\n/**\r\n * Validates the user's token before performing critical operations\r\n * This is especially useful for the Admin dashboard where multiple API calls\r\n * might be triggered at once\r\n */\r\nexport const validateAdminToken = async (): Promise<TokenValidationResponse> => {  try {\r\n    // First try client-side validation which is faster\r\n    const token = localStorage.getItem('token');\r\n    if (!token) {\r\n      console.error('No token found in local storage');\r\n      // Less strict - just tell the caller to get a new token rather than saying invalid\r\n      return { \r\n        valid: false, \r\n        message: 'No authentication token found, needs to login or refresh',\r\n        needsRefresh: true\r\n      };\r\n    }\r\n    \r\n    // Parse and validate the token locally first\r\n    try {\r\n      const payload = parseJwt(token);\r\n      \r\n      if (!payload) {\r\n        console.error('Invalid token format');\r\n        return { valid: false, message: 'Invalid token format', needsRefresh: true };\r\n      }\r\n      \r\n      const expiryTime = payload.exp * 1000; // Convert to milliseconds\r\n      const currentTime = Date.now();\r\n      const isExpired = currentTime > expiryTime;\r\n      \r\n      // Timeframe check - more lenient approach\r\n      const timeToExpiry = (expiryTime - currentTime) / (1000 * 60); // Minutes\r\n      \r\n      if (isExpired) {\r\n        // Check how long ago it expired - if within 48 hours, it might be refreshable\r\n        // Extended from 24 to 48 for better UX during weekend usage\r\n        const expiredAgoMs = currentTime - expiryTime;\r\n        const expiredHours = expiredAgoMs / (1000 * 60 * 60);\r\n        \r\n        if (expiredHours < 48) {\r\n          console.warn(`Token expired ${expiredHours.toFixed(2)} hours ago, attempting to refresh automatically`);\r\n          try {\r\n            // Try to automatically refresh the token here instead of returning invalid\r\n            const { refreshToken } = await import('./tokenRefreshService');\r\n            await refreshToken();\r\n            // If refresh succeeds, consider the token valid now (even though we used a new one)\r\n            console.log('âœ… Automatic token refresh successful during validation');\r\n            return { \r\n              valid: true,\r\n              message: 'Token automatically refreshed',\r\n              expiresAt: new Date(Date.now() + (60 * 60 * 1000)).toISOString(), // Approximate new expiry\r\n              username: payload.sub || payload.username,\r\n              autoRefreshed: true\r\n            };\r\n          } catch (refreshErr) {\r\n            console.warn('Automatic token refresh failed, will let caller handle it:', refreshErr);\r\n            // Don't immediately fail - let the calling code try to refresh it again if needed\r\n            return { \r\n              valid: false, \r\n              message: 'Token has expired but might be refreshable',\r\n              expiresAt: new Date(expiryTime).toISOString(),\r\n              username: payload.sub || payload.username,\r\n              needsRefresh: true\r\n            };\r\n          }\r\n        } else {\r\n          console.error('Token is expired beyond refresh window');\r\n          return { \r\n            valid: false, \r\n            message: 'Token has expired and is too old to refresh',\r\n            expiresAt: new Date(expiryTime).toISOString(),\r\n            username: payload.sub || payload.username\r\n          };\r\n        }\r\n      }\r\n      \r\n      // Proactively refresh if token will expire soon\r\n      if (timeToExpiry < 10) {\r\n        console.warn(`Token will expire soon (${timeToExpiry.toFixed(2)} minutes), starting proactive refresh`);\r\n        // Start async refresh but don't wait for it - consider token still valid\r\n        try {\r\n          const { refreshToken } = await import('./tokenRefreshService');\r\n          refreshToken().catch(err => console.warn('Proactive token refresh failed:', err));\r\n          console.log('Proactive token refresh initiated in background');\r\n        } catch (e) {\r\n          console.warn('Failed to start proactive token refresh:', e);\r\n        }\r\n      }\r\n      \r\n      // Extract roles from token\r\n      const roles = Array.isArray(payload.roles) ? \r\n        payload.roles : \r\n        (payload.authorities || (payload.role ? [payload.role] : []));\r\n      \r\n      // Check for Admin role\r\n      const isAdmin = roles.some((r: string) => r.toUpperCase() === 'ADMIN');\r\n      \r\n      console.log('Token validation result:', {\r\n        valid: true,\r\n        isAdmin,\r\n        username: payload.sub || payload.username,\r\n        expiresAt: new Date(expiryTime).toLocaleString(),\r\n        timeLeft: `${Math.round((expiryTime - currentTime) / 1000 / 60)} minutes`\r\n      });\r\n      \r\n      // If token is valid locally, return validation result\r\n      return {\r\n        valid: true,\r\n        username: payload.sub || payload.username,\r\n        roles,\r\n        expiresAt: new Date(expiryTime).toISOString()\r\n      };\r\n    } catch (e) {\r\n      console.error('Error parsing JWT token:', e);\r\n    }\r\n      // If client-side validation fails or we want to double-check with server,\r\n    // make a lightweight call to the server to validate the token\r\n    const response = await api.get('/auth/validate-token');\r\n    // Apply type assertion for response\r\n    const typedResponse = response as any;\r\n    return { \r\n      valid: true,\r\n      ...(typedResponse || {})\r\n    };\r\n  } catch (error: any) {\r\n    console.error('Token validation error:', error);\r\n    \r\n    // If there was a network error or the server explicitly invalidated the token\r\n    return { \r\n      valid: false, \r\n      message: error.message || 'Token validation failed'\r\n    };\r\n  }\r\n};\r\n\r\nexport default { validateAdminToken };\r\n"],"file":"assets/tokenValidationService-4e567a99.js"}