{"version":3,"file":"paymentHandler-1aec0a02.js","sources":["../../src/utils/paymentDebugger.ts","../../src/services/paymentHandler.ts"],"sourcesContent":["/**\r\n * Special debugging entry points for payment processing\r\n * This provides a direct troubleshooting interface for payment errors\r\n * Only for development and testing purposes\r\n */\r\n\r\nimport api from '../services/api';\r\nimport axios from 'axios';\r\nimport config from '../config/environment';\r\n\r\n/**\r\n * Direct payment submission bypassing the normal service layer\r\n * Use this for debugging when the normal flow fails\r\n */\r\nexport const debugSubmitPayment = async (paymentData: any): Promise<any> => {\r\n  console.log('ðŸ” DEBUG: Submitting payment directly', paymentData);\r\n  \r\n  try {\r\n    // Ensure we have the minimal required fields\r\n    const minimalPayment = {\r\n      feeId: paymentData.feeId || paymentData.studentFeeId || null,\r\n      studentId: paymentData.studentId,\r\n      amount: paymentData.amount,\r\n      paymentMethod: paymentData.paymentMethod,\r\n      transactionReference: paymentData.transactionReference || paymentData.reference || '',\r\n      remarks: paymentData.remarks || paymentData.notes || '',\r\n      payerName: paymentData.payerName || 'Parent/Guardian',\r\n      payerContactInfo: paymentData.payerContactInfo || '',\r\n      payerRelationToStudent: 'PARENT',\r\n      receiptNumber: paymentData.receiptNumber || `RCPT-${Date.now()}`\r\n    };\r\n    \r\n    console.log('Submitting minimal payment data:', minimalPayment);\r\n    \r\n    // Try both with Axios directly and with our API wrapper\r\n    const results = await Promise.allSettled([\r\n      // Try 1: Using our API wrapper\r\n      api.post('/api/fees/payments', minimalPayment),\r\n      \r\n      // Try 2: Using Axios directly\r\n      axios.post(`${config.apiUrl}/api/fees/payments`, minimalPayment, {\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${localStorage.getItem('token')}`\r\n        },\r\n        withCredentials: true\r\n      })\r\n    ]);\r\n    \r\n    console.log('Debug payment submission results:', results);\r\n    \r\n    // Return the successful result if any\r\n    const successfulResult = results.find(r => r.status === 'fulfilled');\r\n    if (successfulResult && successfulResult.status === 'fulfilled') {\r\n      return successfulResult.value;\r\n    }\r\n    \r\n    // If both failed, throw the first error\r\n    if (results[0].status === 'rejected') {\r\n      throw (results[0] as PromiseRejectedResult).reason;\r\n    } else {\r\n      throw (results[1] as PromiseRejectedResult).reason;\r\n    }\r\n  } catch (error) {\r\n    console.error('Error in debug payment submission:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\nexport default { debugSubmitPayment };\r\n","/**\r\n * Payment Handler Service\r\n * \r\n * A comprehensive service that combines all payment-related functionality\r\n * with enhanced CORS handling and error reporting\r\n */\r\n\r\nimport { Payment } from '../types/payment.types';\r\nimport { debugSubmitPayment } from '../utils/paymentDebugger';\r\nimport { reportPaymentError } from '../services/errorReporting';\r\nimport { submitPaymentWithCorsHandling } from '../services/corsHelper';\r\nimport { getAuthHeader } from '../services/authHelper';\r\nimport api from './api';\r\n\r\n/**\r\n * Process a payment with enhanced error handling and CORS management\r\n * Attempts multiple submission methods to ensure the payment goes through\r\n */\r\nexport const processPayment = async (payment: Payment): Promise<Payment> => {  try {\r\n    console.log('Processing payment with enhanced handler:', payment);\r\n      // Ensure we have a valid feeId and validate it\r\n    if (!payment.feeId) {\r\n      throw new Error('No fee ID provided. Please ensure a fee structure exists for this student and is correctly assigned.');\r\n    }\r\n    \r\n    // Additional validation to ensure feeId is a valid number\r\n    const feeId = Number(payment.feeId);\r\n    if (isNaN(feeId) || feeId <= 0) {\r\n      throw new Error(`Invalid fee ID: ${payment.feeId}. Please ensure a valid fee structure is assigned to this student.`);\r\n    }\r\n    \r\n    // Transform to match the backend PaymentRequest format\r\n    const paymentRequest = {\r\n      feeId: feeId,\r\n      studentId: Number(payment.studentId),\r\n      amount: Number(payment.amount),\r\n      paymentMethod: payment.paymentMethod === 'BANK_TRANSFER' ? 'BANK_TRANSFER' : \r\n                    payment.paymentMethod === 'CREDIT_CARD' ? 'CREDIT_CARD' : \r\n                    payment.paymentMethod === 'UPI' ? 'ONLINE' : 'CASH',\r\n      transactionReference: payment.transactionReference || payment.reference || '',\r\n      remarks: payment.remarks || payment.notes || '',\r\n      // Additional fields\r\n      payerName: payment.payerName || 'Parent/Guardian',\r\n      payerContactInfo: payment.payerContactInfo || '',\r\n      payerRelationToStudent: payment.payerRelationToStudent || 'PARENT',\r\n      receiptNumber: payment.receiptNumber || `RCPT-${new Date().getTime().toString().slice(-8)}`\r\n    };\r\n    \r\n    // Try multiple approaches in sequence to handle CORS issues\r\n    try {\r\n      // Approach 1: Use specialized CORS handler\r\n      try {\r\n        console.log('Attempting payment with CORS handler...');\r\n        const result = await submitPaymentWithCorsHandling(paymentRequest);\r\n        console.log('Payment successful with CORS handler');\r\n        return result;\r\n      } catch (corsError) {\r\n        console.warn('CORS handler payment failed, trying standard API', corsError);\r\n        \r\n        // Approach 2: Use standard API with enhanced headers\r\n        try {\r\n          console.log('Attempting payment with standard API...');\r\n          const response = await api.post<Payment>('/api/fees/payments', paymentRequest);\r\n          console.log('Payment successful with standard API');\r\n          return response;\r\n        } catch (apiError) {\r\n          console.error('Standard API payment failed, trying debug method', apiError);\r\n          \r\n          // Approach 3: Last resort - use debug payment method\r\n          console.log('Attempting payment with debug method...');\r\n          const result = await debugSubmitPayment(paymentRequest);\r\n          console.log('Payment successful with debug method');\r\n          return result;\r\n        }\r\n      }\r\n    } catch (finalError) {\r\n      // All methods failed - generate detailed error report\r\n      const diagnostics = reportPaymentError(finalError, paymentRequest);\r\n      console.error('All payment methods failed. Detailed diagnostics:', diagnostics);\r\n      throw finalError;\r\n    }\r\n  } catch (error) {\r\n    console.error('Error in payment processing:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Verify if payment was successful by checking receipt status\r\n */\r\nexport const verifyPaymentReceipt = async (receiptNumber: string): Promise<boolean> => {\r\n  try {\r\n    const response = await api.get(`/api/fees/payments/receipt/${receiptNumber}/verify`);\r\n    // Apply type assertion to safely access data property\r\n    const responseData = response as any;\r\n    return !!(responseData?.data?.verified);\r\n  } catch (error) {\r\n    console.error('Error verifying receipt:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\nexport default {\r\n  processPayment,\r\n  verifyPaymentReceipt\r\n};\r\n"],"names":["debugSubmitPayment","paymentData","minimalPayment","results","api","axios","config","successfulResult","r","error","processPayment","payment","feeId","paymentRequest","result","submitPaymentWithCorsHandling","corsError","response","apiError","finalError","diagnostics","reportPaymentError","verifyPaymentReceipt","receiptNumber","responseData","_a","paymentHandler"],"mappings":"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"}